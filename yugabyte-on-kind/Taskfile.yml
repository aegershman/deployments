# export KUBECONFIG="$(kind get kubeconfig-path)"

version: "2"

env:
  KUBECONFIG:
    sh: kind get kubeconfig-path

tasks:
  create:
    cmds:
      - kind create cluster --config bootstrap/kind.config.yaml
      - task: bootstrap
      - task: sync

  bootstrap:
    cmds:
      - kubectl apply -f bootstrap/rbac-tiller.yml
      - helm init --service-account tiller --upgrade --wait

  delete:
    cmds:
      - kind delete cluster
      - docker system prune --all --volumes --force

  fly:
    cmds:
      - fly -t localhost login -c http://concourse.127.0.0.1.nip.io -u test -p test -n main -k
      - fly -t localhost sync
      - fly -t localhost sp -p basic -c bootstrap/basic-pipeline.yml -n
      - fly -t localhost unpause-pipeline -p basic

  sync:
    cmds:
      - helmfile sync
