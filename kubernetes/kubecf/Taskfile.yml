---
version: "2"

tasks:
  rm-crds:
    cmds:
      - |
        kubectl delete crd boshdeployments.quarks.cloudfoundry.org
        kubectl delete crd quarksjobs.quarks.cloudfoundry.org
        kubectl delete crd quarkssecrets.quarks.cloudfoundry.org
        kubectl delete crd quarksstatefulsets.quarks.cloudfoundry.org

  crds-placeholder:
    cmds:
      # not to be actually ran as a task; just here for copy-paste-ability
      - exit 1
      - |
        kubectl get crds
        kubectl describe boshdeployments.quarks.cloudfoundry.org
        kubectl describe quarksjobs.quarks.cloudfoundry.org
        kubectl describe quarkssecrets.quarks.cloudfoundry.org
        kubectl describe quarksstatefulsets.quarks.cloudfoundry.org
      - |
        kubectl get boshdeployments.quarks.cloudfoundry.org
        kubectl get quarksjobs.quarks.cloudfoundry.org
        kubectl get quarkssecrets.quarks.cloudfoundry.org
        kubectl get quarksstatefulsets.quarks.cloudfoundry.org

  post-installation-validation:
    cmds:
      - | # check if the cf api is responding
        cf api --skip-ssl-validation api.kubecf.127.0.0.1.xip.io
      - | # retrieve cf admin password
        kubectl -n kubecf get secret kubecf.var-cf-admin-password -o jsonpath='{.data.password}' | base64 --decode
        cf auth admin PASSWORD_FROM_ABOVE

  logs-placeholder:
    cmds:
      # not to be actually ran as a task; just here for copy-paste-ability
      - exit 1
      - |
        kubectl logs -f --tail=250 deployment.apps/cf-operator
        kubectl logs -f --tail=250 deployment.apps/cf-operator-quarks-job
      - |
        kubectl -n kubecf get all
        kubectl -n kubecf get pods
        kubectl -n kubecf get sts
      - | # trust me, it's kind of a fun game to follow this tree of thing-waiting-on-thing
        kubectl -n kubecf logs -f sts/kubecf-adapter -c wait-for
        kubectl -n kubecf logs -f sts/kubecf-api -c wait-for
        kubectl -n kubecf logs -f sts/kubecf-bits -c wait-for
        kubectl -n kubecf logs -f sts/kubecf-credhub -c wait-for
        kubectl -n kubecf logs -f sts/kubecf-diego-api -c wait-for
        kubectl -n kubecf logs -f sts/kubecf-doppler -c wait-for
        kubectl -n kubecf logs -f sts/kubecf-eirini -c wait-for
        kubectl -n kubecf logs -f sts/kubecf-log-api -c wait-for
        kubectl -n kubecf logs -f sts/kubecf-nats -c wait-for
        kubectl -n kubecf logs -f sts/kubecf-router -c wait-for
        kubectl -n kubecf logs -f sts/kubecf-routing-api -c wait-for
        kubectl -n kubecf logs -f sts/kubecf-singleton-blobstore -c wait-for
        kubectl -n kubecf logs -f sts/kubecf-uaa -c wait-for
      - |
        kubectl -n kubecf logs -f --tail=250 kubecf-database-0 -c database
        kubectl -n kubecf logs -f --tail=250 kubecf-database-0 -c logs
      - |
        kubectl -n kubecf describe pod -lquarks.cloudfoundry.org/qjob-name=ig-kubecf
        kubectl -n kubecf logs -f -lquarks.cloudfoundry.org/qjob-name=ig-kubecf
