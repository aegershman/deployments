# https://github.com/cloudfoundry/runtime-ci/blob/master/ci/infrastructure.yml
# https://github.com/cloudfoundry/cf-deployment/blob/master/ci/pipelines/cf-deployment.yml#L434
# https://github.com/concourse/git-resource/pull/151
# https://github.com/AGWA/git-crypt

resources:

# Plan patches
# - name: bosh-bootloader
#   type: git
#   source:
#     branch: master
#     uri: https://github.com/cloudfoundry/bosh-bootloader

- name: relint-envs
  type: git
  source:
    branch: master
    uri: https://github.com/aegershman/deployments-state.git
    username: ((relint_envs_username))
    password: ((relint_envs_password))


# Code repos
- name: cf-deployment-concourse-tasks
  type: git
  source:
    branch: master
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks.git

jobs:

- name: setup-infrastructure-experimental
  plan:
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: relint-envs
  - task: setup-infrastructure
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_STATE_DIR: environments/test/hermione/bbl-state
      BBL_IAAS: aws
      BBL_AWS_REGION: us-east-2
      BBL_AWS_ACCESS_KEY_ID: ((bbl_aws_access_key_id))
      BBL_AWS_SECRET_ACCESS_KEY: ((bbl_aws_secret_access_key))
      SKIP_LB_CREATION: 'true'
      # BBL_LB_CERT: ((bbl_lbs_certificate))
      # BBL_LB_KEY: ((bbl_lbs_private_key))
      # BBL_LB_CERT_CHAIN: ((bbl_lbs_ca))
      LB_DOMAIN: cf.gershman.io #hermione.cf-app.com
      BBL_ENV_NAME: bbl-gershman #hermione-experimental
    input_mapping:
      bbl-state: relint-envs
      bbl-config: relint-envs
    ensure:
      put: relint-envs
      params:
        repository: updated-bbl-state
        rebase: true

- name: destroy-infrastructure-experimental
  # serial_groups: [hermione]
  # public: true
  plan:
  - in_parallel:
    # - put: experimental-pool
    #   params: {claim: hermione}
    - get: relint-envs
    - get: cf-deployment-concourse-tasks
  # - task: guarantee-no-existing-cf-deployment
  #   file: cf-deployment-concourse-tasks/bosh-delete-deployment/task.yml
  #   input_mapping:
  #     bbl-state: relint-envs
  - task: destroy-infrastructure
    file: cf-deployment-concourse-tasks/bbl-destroy/task.yml
    params:
      BBL_STATE_DIR: environments/test/hermione/bbl-state
      BBL_AWS_ACCESS_KEY_ID: ((bbl_aws_access_key_id))
      BBL_AWS_SECRET_ACCESS_KEY: ((bbl_aws_secret_access_key))
    input_mapping:
      bbl-state: relint-envs
    ensure:
      put: relint-envs
      params:
        repository: updated-bbl-state
        rebase: true
